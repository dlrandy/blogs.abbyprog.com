---
templateKey: blog-post
id:refactoring-first
title: refactoring 第一弹
slug: /2021/03/20/refactoring-first/
date: 2021-03-20T03:48:03.125Z
description: 学习一些重构相关的知识
headerImage: https://i.imgur.com/Ivxkc3R.jpg
tags:
  - refactoring
---

### clean code
重构的主要目的是应对技术债务。把一团糟变成干净的code和简单的设计。

clean code的几个特点：
1. 干净的code对于其他的开发者是明显易见的
  这里不说超复杂的算法。不好的变量命名，臃肿的类和方法，黑魔法等等这些
  都使得code混乱难以理解
2. 干净的code不包含重复
  在重复的code里做改变的时候，必须要记住给每个实例添加同样的改变。
  增加认知负荷的同时还影响进度。
3. 干净的code包含最少数量的类和其他变化的部分
  code越少，记在脑子里的事情越少，维护的东西就越少，bug也会越少。
  code是责任，请保持它的短小和简单
4. 干净的code会通过所有的测试
  code只有95%通过测试那么它属于肮脏的code，测试覆盖率为0，那么你就完蛋了。
5. 干净的code能更简单和更低成本的维护

### 技术债
就像是贷款。为了马上买一些东西，可以贷款，但是这样不但要偿还本金，
还有利息。利息超过了收入，那么完全的还债是不可能的了。

技术债一般是因为为了加速开发，一些需要做的事情(重构，测试等)没有做，
最终会拖慢进度。

#### 技术债的诱因
1. 业务压力
  一些业务环境可能在特性完成之前，就推出这个特性(功能)。
  在这种情况下，补丁和不明确的零件集合出现在code里，来隐藏
  项目未完成的部分。
2. 对技术债后果的理解的缺失
  老板当前可能不知道技术债有代价--随着技术债的积累会减慢开发速度。
  看不到代价就很难给team时间去重构，因为管理者看不到重构的价值。
3. 没有解决组件之间的紧密衔接性
  这通常是项目是整体，而不是一个个独立模块的产品。这样项目的任何部分
  有改变都可能会影响到其他部分。team的开发也会更困难，因为很难去隔离
  每个人的工作
4. 测试的缺失
  立即反馈的缺失会导致有风险的解决办法或者零件。糟糕的情况，可能是修改在
  没有测试的情况下直接部署到了正式环境。后果可能灾难性的。例如一个貌似无辜
  的快速修复，可能会发送测试邮件给成千上万的客户，还有可能损坏数据库。
5. 文档的缺失
  这会减慢新人的进入。如果关键的人离开了项目，可能会迫使开发停下来。
6. 成员之间缺乏交流
  如果知识基础没有在团队里普及，那么有些人对项目的信息和流程的理解就会
  过时。这种情况会被加剧，特别是在导师不正确的培训了初级开发者。
7. 长期的多分支同时开发
  这会导致技术债的积累，在合并改变的时候，债务更是会增加。独立的改变越多，
  技术债的总额越大。
8. 延期的重构
  项目的需求不断改变。有些时候很明显有些部分的code是过时的，或者是
  累赘的，但是又被分配了必须要完成的新需求。项目的开发人员只能在新的code里，
  使用过时的部分。因此重构被推迟的时间越长，未来需要调整的依赖code越多。
9. 合规性监控的缺失
  一般发生在项目里的每个人以自己舒服习惯的方式写code的时候
10. 能力不足
  开发者不知道如何去写出合适的code

### 什么时候重构
重构时机的3个原则
1. 在首次做某事，刚好完成的时候
2. 在第二次做类似事情，但又必须重复做了同样事情的时候
3. 在第三次做某事的时候，开始重构

#### 在添加新特性的时候
- 重构帮助你理解他人的code。如果你必须处理他人肮脏的code，
首先试着去重构它。干净的code更容易理解掌握。你要改善它不仅是为了你自己，
也为了后来使用它的人
- 重构使得添加新的特性更容易。在干净的code里做调整也更容易
#### 修bug的时候
- 代码行为里的bugs就像是现实生活中的虫子：它们生活在最阴暗最肮脏的
code角落里。清理code和错误的过程中就会发现它们。管理人员赞赏积极主动
的重构，因为这样就消除了后续专门重构任务的需要。快乐老板让开发人员快乐。

#### code review的时候
code review可能是code上线签的最后清理code的机会。
最好是和code的作者一起去执行这样的review。这样的方式可以快速的修复一些简单的问题，
省出事件修复更难的问题

### 如何去重构
重构应该是一系列的小的改动，每个改动都会使得已有的code稍稍的变好，同时保持程序
的正常运行

### 正确执行重构清单
1. 代码应该变得更为清晰整洁
  重构之后，code仍然不整洁，那么你已经浪费了你的声明的一个时辰。尝试去理解为什么
  会出现这种问题。这通常是发生在你做了和重构背道而驰的小改变以及将一堆的重构合成了
  一个大的改变。所以它很容易失去初心，特别是有时间限制的情况下。也可能发生在目前的code
  实在极端混乱的时候，无论你改善了什么，code整体仍然是一个灾难。这种情况下，值得去思考
  完全的重写code的某些部分。但是重写前，你应该写好测试并且预留出大量时间。否则code
  最终可能仍然不干净。

2. 重构期间不应该创建新的功能
 不要将重构和新特性的直接开发混在一起。将两个程序分开，至少也应该是在独立的commit里。
3. 重构之后，所有的已有测试必须通过
  重构之后，测试未通过有两种情况：
   1. 重构的时候产生了错误
   2. 测试太低级
     比如测试了类的私有方法。要么重构测试，要么写新的一组高级测试。避免这种
     情况，一般是写BDD风格的测试




